{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤</h2>
<form method="get" id="filter-form" class="row g-3 mb-4 align-items-end">
    <div class="col-md-3">
        <label for="q" class="form-label">–ü–æ—à—É–∫</label>
        <input type="text" id="q" name="q" class="form-control" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É" value="{{ query }}">
    </div>
    <div class="col-md-2">
        <label for="price" class="form-label">–ú–∞–∫—Å. —Ü—ñ–Ω–∞</label>
        <input type="number" id="price" name="price" class="form-control" placeholder="–¶—ñ–Ω–∞" value="{{ price }}">
    </div>
    <div class="col-md-3">
        <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
        <select id="category" name="category" class="form-select">
            <option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
            {% for cat in categories %}
                <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
    <label for="sort" class="form-label">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</label>
    <select name="sort" id="sort" class="form-select">
        <option value="">–ë–µ–∑ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è</option>
        <option value="price_asc" {% if selected_sort =='price_asc' %}selected{% endif %}>–¶—ñ–Ω–∞ ‚Üë</option>
        <option value="price_desc" {% if selected_sort =='price_desc' %}selected{% endif %}>–¶—ñ–Ω–∞ ‚Üì</option>
    </select>
</div>
    <div class="col-md-3">
        <label for="subcategory" class="form-label">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
        <select id="subcategory" name="subcategory" class="form-select">
            <option value="">–£—Å—ñ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
            {% if selected_category in subcategories %}
                {% for sub in subcategories[selected_category] %}
                    <option value="{{ sub }}" {% if selected_subcategory == sub %}selected{% endif %}>{{ sub }}</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>
    <div class="col-md-1 d-grid">
        <button class="btn btn-primary">üîç</button>
    </div>
    <div class="col-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</a>
    </div>
</form>
{% if products %}
    <p class="text-muted mb-3">
        ‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ {{ products|length }}
        {{ '—Ç–æ–≤–∞—Ä' if products|length == 1 else '—Ç–æ–≤–∞—Ä–∏' if products|length < 5 else '—Ç–æ–≤–∞—Ä—ñ–≤' }}
    </p>
{% endif %}
{% if products %}
<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for product in products %}
    <div class="col">
        <div class="card h-100 shadow-sm">
            {% if product.image %}
            <img src="{{ url_for('static', filename='uploads/' ~ product.image) }}"
                 class="card-img-top product-image"
                 alt="{{ product.name }}">
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="card-text"><strong>–¶—ñ–Ω–∞:</strong> {{ product.price }} ‚Ç¥</p>
                {% if product.category %}
                    <span class="badge bg-info text-dark">{{ product.category }}</span>
                {% endif %}
                {% if product.subcategory %}
                    <span class="badge bg-secondary">{{ product.subcategory }}</span>
                {% endif %}
                <a href="{{ url_for('add_to_cart', product_id=product.id) }}"
                   class="btn btn-primary mt-auto">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-warning text-center" role="alert">
    üßê –¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç.
</div>
{% endif %}
<script>
    const subcategoryMap = {{ subcategories | tojson }};
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    categorySelect.addEventListener('change', () => {
        const selected = categorySelect.value;
        const options = subcategoryMap[selected] || [];
        subcategorySelect.innerHTML = '<option value="">–£—Å—ñ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>';
        options.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            subcategorySelect.appendChild(opt);
        });
    });
</script>
{% endblock %}